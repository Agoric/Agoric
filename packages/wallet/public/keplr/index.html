<!DOCTYPE html>
<html>
  <head>
    <title>Agoric || Add Keplr</title>
  </head>
  <body>
    <style>
      .nodisplay {
        display: none;
      }
    </style>

    <div class="network-config nodisplay">
    <select id="networks">
      <option selected value="https://devnet.agoric.net/network-config">Agoric Devnet</option>
      <option value="https://testnet.agoric.net/network-config">Agoric
        Testnet</option>
    </select>
    <input id="networkConfig" value="" size="50">
    <button id="chooseNetworkConfig">Install Network</button>
    </div>

    <div class="instructions">
      <p>You must first <a target="_blank" href="https://chrome.google.com/webstore/detail/keplr/dmkamcknogkgcdfhhbddcghachkejeap">install the Keplr wallet</a>.</p>
    </div>

    <script type="module">
      import '@agoric/wallet/components/install-ses-lockdown.js';
      window.addEventListener('load', async _ => {
        if (window.keplr) {
          document.querySelectorAll('.instructions').forEach(el => el.classList.add('nodisplay'));
          window.keplr.enable('agoric').finally(_ => {
            document.querySelectorAll('.network-config').forEach(el => el.classList.remove('nodisplay'));
          });
          return;
        }
      });

      async function suggestChain(nc) {
        // alert('networkConfig ' + networkConfig.value);
        const res = await fetch(nc);
        const { chainName: chainId, rpcAddrs } = await res.json();
        const rpcAddr = rpcAddrs[Math.floor(Math.random() * rpcAddrs.length)];
        const network = new URL(nc).hostname.split('.')[0];
        const stakeCurrency = {
          coinDenom: 'BLD',
          coinMinimalDenom: 'ubld',
          coinDecimals: 6,
          coinGeckoId: undefined,
        };
        const stableCurrency = {
          coinDenom: 'RUN',
          coinMinimalDenom: 'urun',
          coinDecimals: 6,
          coinGeckoId: undefined,
        };
        const chainInfo = {
          rpc: `http://${rpcAddr}`,
          rest: `http://${rpcAddr.replace(/:\d+$/, ':1317')}`,
          chainId,
          chainName: `Agoric ${network}`,
          stakeCurrency,
          walletUrlForStaking: `https://${network}.staking.agoric.app`,
          bip44: {
            coinType: 564,
          },
          bech32Config: {
            bech32PrefixAccAddr: 'agoric',
            bech32PrefixAccPub: 'agoricpub',
            bech32PrefixValAddr: 'agoricvaloper',
            bech32PrefixValPub: 'agoricvaloperpub',
            bech32PrefixConsAddr: 'agoricvalcons',
            bech32PrefixConsPub: 'agoricvalconspub',
          },
          currencies: [
            stakeCurrency,
            stableCurrency,
          ],
          feeCurrencies: [
            stableCurrency,
          ],
          features: ['stargate', 'ibc-transfer'],
        };
        await window.keplr.experimentalSuggestChain(chainInfo);
      }

      networkConfig.value = networks.value;
      chooseNetworkConfig.addEventListener('click', async ev => {
        const nc = networkConfig.value;
        try {
          await suggestChain(nc);
          alert(`${nc} installed!`);
        } catch (e) {
          console.log(e);
          alert(`Failed: ${e}`);
        }
      });
      ['change', 'click'].forEach(eventName => 
        networks.addEventListener(eventName, ev => {
          console.log('have el', networks.value);
          networkConfig.value = networks.value;
        })
      );
    </script>
  </body>
</html>