<!DOCTYPE html>
<html>
  <head>
    <title>Sample Dapp</title>
  </head>
  <body>
    <h1>Dapp UI</h1>
    <div id="spinner"></div>
    <input id="sendTo" placeholder="Wallet request" /><button id="doSend">Send
    to Wallet</button>
    <div id="recvFrom">*loading*</div>
    <iframe height="0" width="0" style="display: none" src="http://localhost:3000/web-solo/"></iframe>
    <script>
      let spin = 0;
      const spinText = ['/', '-', '\\', '|'];
      setInterval(() => {
        spinner.innerText = spinText[spin];
        spin = (spin + 1) % spinText.length;
      }, 200);

      let sendQ = [];
      const wallet = document.querySelector('iframe');
      const send = obj => {
        recvFrom.innerText = '*working*';
        wallet.contentWindow.postMessage(['fromDapp', obj], '*');
      };
      window.addEventListener('message', ev => {
          switch (ev.data[0]) {
            case 'toDapp': {
              console.log('toDapp got', ev.data);
              recvFrom.innerText = ev.data[1];
              break;
            }
          }
        });
      wallet.addEventListener('load', ev => {
        recvFrom.innerText = '';
        while (sendQ.length > 0) {
          send(sendQ.shift());
        }
        sendQ = null;
      });
      doSend.addEventListener('click', ev => {
        if (sendQ) {
          sendQ.push(sendTo.value);
        } else {
          send(sendTo.value);
        }
        sendTo.value = '';
      });
    </script>
  </body>
</html>
